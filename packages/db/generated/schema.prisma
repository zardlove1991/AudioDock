// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../generated" /// è‡ªå®šä¹‰ä¸ºæºä»£ç ç›®å½•å†…çš„ç›¸å¯¹è·¯å¾„
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum TrackType {
  MUSIC
  AUDIOBOOK
}

model Track {
  id             Int       @id @default(autoincrement())
  name           String
  path           String
  artist         String
  album          String
  cover          String?
  duration       Int?
  lyrics         String?
  index          Int? // Track order within the album
  type           TrackType @default(MUSIC)
  createdAt      DateTime  @default(now())
  fileModifiedAt DateTime?
  episodeNumber  Int?      @default(0)

  // Relations to entity tables (Optional for compatibility with existing string fields)
  artistId     Int?
  artistEntity Artist? @relation(fields: [artistId], references: [id])
  albumId      Int?
  albumEntity  Album?  @relation(fields: [albumId], references: [id])

  /// ğŸ” åå‘å…³ç³»
  likedByUsers               UserTrackLike[]
  listenedByUsers            UserTrackHistory[]
  likedAsAudiobookByUsers    UserAudiobookLike[]
  listenedAsAudiobookByUsers UserAudiobookHistory[]
  playlists                  Playlist[]
  folderId                   Int?
  folder                     Folder?                @relation(fields: [folderId], references: [id])
}

model Album {
  id     Int       @id @default(autoincrement())
  name   String
  artist String
  cover  String?
  year   String?
  type   TrackType @default(MUSIC)

  tracks Track[]

  /// ğŸ” åå‘å…³ç³»
  likedByUsers    UserAlbumLike[]
  listenedByUsers UserAlbumHistory[]
}

model Artist {
  id     Int       @id @default(autoincrement())
  name   String
  avatar String?
  type   TrackType @default(MUSIC)

  tracks Track[]
}

model UserTrackLike {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  track     Track    @relation(fields: [trackId], references: [id])
  trackId   Int
  createdAt DateTime @default(now())
}

model UserTrackHistory {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
  track      Track    @relation(fields: [trackId], references: [id])
  trackId    Int
  listenedAt DateTime @default(now())
  progress   Int      @default(0)
  deviceName String
  device     Device   @relation(fields: [deviceId], references: [id])
  deviceId   Int
  isSyncMode Boolean  @default(false)
}

model UserAlbumLike {
  /// ä¸»é”® IDï¼Œè‡ªå¢
  id        Int      @id @default(autoincrement())
  /// å¤–é”®ï¼šå…³è”ç”¨æˆ·
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  /// å¤–é”®ï¼šå…³è”ä¸“è¾‘
  album     Album    @relation(fields: [albumId], references: [id])
  albumId   Int
  /// ç”¨æˆ·ç‚¹èµè¯¥ä¸“è¾‘çš„æ—¶é—´
  createdAt DateTime @default(now())
}

model UserAlbumHistory {
  /// ä¸»é”® IDï¼Œè‡ªå¢
  id         Int      @id @default(autoincrement())
  /// å¤–é”®ï¼šå…³è”ç”¨æˆ·
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
  /// å¤–é”®ï¼šå…³è”ä¸“è¾‘
  album      Album    @relation(fields: [albumId], references: [id])
  albumId    Int
  /// ç”¨æˆ·æ”¶å¬è¯¥ä¸“è¾‘çš„æ—¶é—´
  listenedAt DateTime @default(now())
}

model UserAudiobookLike {
  /// ä¸»é”® IDï¼Œè‡ªå¢
  id        Int      @id @default(autoincrement())
  /// å¤–é”®ï¼šå…³è”ç”¨æˆ·
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  /// å¤–é”®ï¼šå…³è”æœ‰å£°ä¹¦ Track
  track     Track    @relation(fields: [trackId], references: [id])
  trackId   Int
  /// ç”¨æˆ·ç‚¹èµè¯¥æœ‰å£°ä¹¦çš„æ—¶é—´
  createdAt DateTime @default(now())
}

model UserAudiobookHistory {
  /// ä¸»é”® IDï¼Œè‡ªå¢
  id         Int      @id @default(autoincrement())
  /// å¤–é”®ï¼šå…³è”ç”¨æˆ·
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
  /// å¤–é”®ï¼šå…³è”æœ‰å£°ä¹¦ Track
  track      Track    @relation(fields: [trackId], references: [id])
  trackId    Int
  /// ç”¨æˆ·æ”¶å¬è¯¥æœ‰å£°ä¹¦çš„æ—¶é—´
  listenedAt DateTime @default(now())
  progress   Int      @default(0)

  @@unique([userId, trackId])
}

model User {
  /// ç”¨æˆ· IDï¼Œè‡ªå¢ä¸»é”®
  id                 Int                    @id @default(autoincrement())
  /// ç”¨æˆ·åï¼Œå”¯ä¸€æ ‡è¯†ï¼Œç”¨äºç™»å½•
  username           String                 @unique
  /// åŠ å¯†åçš„ç”¨æˆ·å¯†ç 
  password           String
  /// æ˜¯å¦ä¸ºç®¡ç†å‘˜ç”¨æˆ·ï¼Œé»˜è®¤ false
  is_admin           Boolean                @default(false)
  /// ç”¨æˆ·å–œæ¬¢çš„éŸ³ä¹å•æ›²åˆ—è¡¨
  likedTracks        UserTrackLike[]
  /// ç”¨æˆ·å¬è¿‡çš„éŸ³ä¹å•æ›²å†å²è®°å½•
  listenedTracks     UserTrackHistory[]
  /// ç”¨æˆ·å–œæ¬¢çš„ä¸“è¾‘åˆ—è¡¨
  likedAlbums        UserAlbumLike[]
  /// ç”¨æˆ·å¬è¿‡çš„ä¸“è¾‘å†å²è®°å½•
  listenedAlbums     UserAlbumHistory[]
  /// ç”¨æˆ·å–œæ¬¢çš„æœ‰å£°ä¹¦åˆ—è¡¨
  likedAudiobooks    UserAudiobookLike[]
  /// ç”¨æˆ·å¬è¿‡çš„æœ‰å£°ä¹¦å†å²è®°å½•
  listenedAudiobooks UserAudiobookHistory[]
  /// ç”¨æˆ·åˆ›å»ºçš„æ’­æ”¾åˆ—è¡¨
  playlists          Playlist[]
  /// ç”¨æˆ·è®¾å¤‡åˆ—è¡¨
  devices            Device[]
}

model Device {
  id        Int                @id @default(autoincrement())
  name      String
  user      User               @relation(fields: [userId], references: [id])
  userId    Int
  isOnline  Boolean            @default(false)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  histories UserTrackHistory[]
}

model Playlist {
  id        Int       @id @default(autoincrement())
  name      String
  type      TrackType @default(MUSIC)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user   User @relation(fields: [userId], references: [id])
  userId Int

  tracks Track[]
}

model Folder {
  id       Int       @id @default(autoincrement())
  path     String    @unique // æ–‡ä»¶å¤¹çš„å”¯ä¸€è·¯å¾„
  name     String
  parentId Int? // æŒ‡å‘çˆ¶æ–‡ä»¶å¤¹
  parent   Folder?   @relation("SubFolders", fields: [parentId], references: [id])
  children Folder[]  @relation("SubFolders")
  type     TrackType @default(MUSIC)
  tracks   Track[]
}
